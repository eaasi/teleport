.imagejob:
  image: docker:latest
  stage: build
  services:
  - docker:dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_DRIVER: "overlay2"
    BUILDX_VERSION: "v0.6.3"
    image: "${CI_REGISTRY_IMAGE}/${service}"
    tag: "${CI_COMMIT_REF_SLUG}"
  before_script:
  # install docker's buildx plugin
  - srcurl="https://github.com/docker/buildx/releases/download/${BUILDX_VERSION}/buildx-${BUILDX_VERSION}.linux-amd64"
  - dstdir="${HOME}/.docker/cli-plugins"
  - mkdir -p "${dstdir}"
  - wget -O "${dstdir}/docker-buildx" "${srcurl}"
  - chmod a+x "${dstdir}/docker-buildx"
  - unset srcurl dstdir
  # prepare build environment
  - docker info
  - echo "${CI_REGISTRY_PASSWORD}" | docker login --password-stdin -u "${CI_REGISTRY_USER}" "${CI_REGISTRY}"
  - docker context create eaasi
  - docker buildx create --name eaasi --driver docker-container --use eaasi
  - docker buildx inspect --bootstrap eaasi
  - is_latest() test "${CI_COMMIT_REF_SLUG}" = "${CI_DEFAULT_BRANCH}"
  script:
  # optionally, load image into local docker instance
  - if is_latest; then outargs='--output "type=docker"'; fi
  # build and push image, export all intermediate layers as cache
  - docker buildx build --progress plain --output 'type=registry' ${outargs}
        --cache-to "type=registry,mode=max,ref=${image}:buildcache"
        --cache-from "type=registry,ref=${image}:buildcache"
        --tag "${image}:${tag}" "${workdir}"
  # optionally, update latest tag
  - if is_latest; then
      docker tag "${image}:${tag}" "${image}:latest";
      docker push "${image}:latest";
    fi

database-image:
  extends: ".imagejob"
  variables:
    service: "eaasi-database"
    workdir: "./eaasi-database"

front-end-image:
  extends: ".imagejob"
  variables:
    GIT_SUBMODULE_STRATEGY: "recursive"
    service: "eaasi-front-end"
    workdir: "."

web-api-image:
  extends: ".imagejob"
  variables:
    service: "eaasi-web-api"
    workdir: "./eaasi-web-api"

start-env:
  image: alpine:latest
  stage: cleanup
  environment:
    name: "docker/${CI_COMMIT_REF_SLUG}"
    on_stop: cleanup
  variables:
    GIT_STRATEGY: "none"
  script:
  - exit 0

cleanup:
  image: alpine:latest
  stage: cleanup
  when: manual
  environment:
    name: "docker/${CI_COMMIT_REF_SLUG}"
    action: stop
  variables:
    GIT_STRATEGY: "none"
  before_script:
  - apk add --no-cache skopeo
  - echo "${CI_REGISTRY_PASSWORD}" | skopeo login --password-stdin -u "${CI_REGISTRY_USER}" "${CI_REGISTRY}"
  script:
  - | # delete docker image for given service and tag
    delete_docker_image() {
      local service="$1";
      local tag="$2";
      local image="${CI_REGISTRY_IMAGE}/${service}";
      echo "Deleting docker-image '${image}:${tag}'...";
      skopeo delete "${image}:${tag}";
    }
  - | # delete docker images + caches for current branch
    for service in eaasi-database eaasi-front-end eaasi-web-api; do
      delete_docker_image "${service}" "${CI_COMMIT_REF_SLUG}";
      delete_docker_image "${service}" "buildcache";
    done
